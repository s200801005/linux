#!/usr/bin/env bash
##################################
kde_config_module_for_fcitx() {
    DEPENDENCY_01=""
    DEPENDENCY_02='kcm-fcitx'
    if [ "${LINUX_DISTRO}" = "arch" ]; then
        DEPENDENCY_02='kcm-fcitx'
        #kcm-fcitx
    elif [ "${LINUX_DISTRO}" = "debian" ]; then
        DEPENDENCY_02='kde-config-fcitx'
        #kde-config-fcitx
    fi
    beta_features_quick_install
}
############
tmoe_fcitx5_menu() {
    check_zstd
    RETURN_TO_WHERE='tmoe_fcitx5_menu'
    
    INPUT_METHOD=$(
        whiptail --title "Fcitx5" --menu "Fcitx5 ÊòØÁªß Fcitx ÂêéÁöÑÊñ∞‰∏Ä‰ª£ËæìÂÖ•Ê≥ïÊ°ÜÊû∂„ÄÇ\nËØçÂ∫ìÊòØËæìÂÖ•Ê≥ï‰øùÂ≠òÁöÑ‰∏Ä‰∫õÊµÅË°åËØçËØ≠„ÄÅÂ∏∏Áî®ËØçËØ≠Êàñ‰∏ì‰∏öÊúØËØ≠Á≠âÁöÑ‰ø°ÊÅØ,\nÊ∑ªÂä†ÊµÅË°åËØçÂ∫ìËÉΩÂ¢ûÂä†ÊµÅË°åÂÄôÈÄâËØçÁöÑÂëΩ‰∏≠Áéá" 0 55 0 \
            "1" "fcitx5ÂÆâË£Ö‰∏éÂç∏ËΩΩ" \
            "2" "ËÇ•Áå´Áôæ‰∏áÂ§ßËØçÂ∫ì@felixonmars" \
            "3" "ËêåÂ®òÁôæÁßëËØçÂ∫ì@outloudvi" \
            "4" "fcitx5-rime" \
            "5" "beautificationËæìÂÖ•Ê≥ïÁæéÂåñ‰∏ªÈ¢ò" \
            "0" "üåö Return to previous menu ËøîÂõû‰∏äÁ∫ßËèúÂçï" \
            3>&1 1>&2 2>&3
    )
    case ${INPUT_METHOD} in
    0 | "") install_pinyin_input_method ;;
    1) install_fcitx5 ;;
    2) felixonmars_fcitx5_wiki_dict ;;
    3) outloudvi_fcitx5_moegirl_dict ;;
    4) install_fcitx5_rime ;;
    5) input_method_beautification ;;
    esac
    #"5" "Material DesignË¥®ÊÑü‰∏ªÈ¢ò@hosxy" \
    ###############
    press_enter_to_return
    tmoe_fcitx5_menu
}
############
input_method_beautification() {
    RETURN_TO_WHERE='input_method_beautification'
    DEPENDENCY_01=''
    
    FCIITX5_CLASSUI_CONF_PATH="${HOME}/.config/fcitx5/conf"
    FCIITX5_CLASSUI_CONF_FILE="${FCIITX5_CLASSUI_CONF_PATH}/classicui.conf"
    INPUT_METHOD=$(
        whiptail --title "Fcitx5" --menu "fcitx‰∏ªÈ¢ò" 0 55 0 \
            "1" "Material Design(ÂæÆËΩØÊãºÈü≥È£éÊ†º)@hosxy" \
            "2" "kimpanel(ÊîØÊåÅkde-wayland)" \
            "3" "gnome-shell-extension-kimpanel(ÊîØÊåÅgnome-wayland)" \
            "4" "edit configÁºñËæë‰∏ªÈ¢òÈÖçÁΩÆ" \
            "0" "üåö Return to previous menu ËøîÂõû‰∏äÁ∫ßËèúÂçï" \
            3>&1 1>&2 2>&3
    )
    case ${INPUT_METHOD} in
    0 | "") tmoe_fcitx5_menu ;;
    1) configure_fcitx5_material_color_theme ;;
    2) install_kimpanel ;;
    3) install_gnome_shell_extension_kimpanel ;;
    4) edit_fcitx_theme_config_file ;;
    esac
    ###############
    press_enter_to_return
    input_method_beautification
}
##############
edit_fcitx_theme_config_file() {
    if [ $(command -v editor) ]; then
        editor ${FCIITX5_CLASSUI_CONF_FILE}
    else
        nano ${FCIITX5_CLASSUI_CONF_FILE}
    fi
    chown ${CURRENT_USER_NAME}:${CURRENT_USER_GROUP} ${FCIITX5_CLASSUI_CONF_FILE}
}
#############
configure_fcitx5_material_color_theme() {
    RETURN_TO_WHERE='configure_fcitx5_material_color_theme'
    MATERIAL_COLOR_FOLDER="${HOME}/.local/share/fcitx5/themes/Material-Color"
    CURRENT_FCITX5_COLOR="$(ls -l ${MATERIAL_COLOR_FOLDER}/panel.png | awk -F ' ' '{print $NF}' | cut -d '-' -f 2 | cut -d '.' -f 1)"
    if [ ! -z "${CURRENT_FCITX5_COLOR}" ]; then
        FCITX_THEME_STATUS="Ê£ÄÊµãÂà∞ÂΩìÂâçfcitx5-material‰∏ªÈ¢òÈÖçËâ≤‰∏∫${CURRENT_FCITX5_COLOR}"
    else
        FCITX_THEME_STATUS="Ê£ÄÊµãÂà∞ÊÇ®Êú™ÊåáÂÆöfcitx5-material‰∏ªÈ¢òÁöÑÈÖçËâ≤"
    fi
    if [ ! -e "${MATERIAL_COLOR_FOLDER}" ]; then
        FCITX_THEME_STATUS="Ê£ÄÊµãÊÇ®Â∞öÊú™‰∏ãËΩΩfcitx5-material‰∏ªÈ¢ò"
    fi
    PANEL_COLOR_PNG=''
    #DEPENDENCY_01=''
    #
    INPUT_METHOD=$(
        whiptail --title "Fcitx5 Material Design" --menu "https://github.com/hosxy/Fcitx5-Material-Color\nÊÇ®ÂèØ‰ª•Âú®‰∏ãËΩΩÂÆåÊàêÂêéÔºåËá™Áî±‰øÆÊîπ‰∏ªÈ¢òÈÖçËâ≤„ÄÇ\n${FCITX_THEME_STATUS}" 0 55 0 \
            "1" "download‰∏ãËΩΩ/Êõ¥Êñ∞" \
            "2" "deleteÂà†Èô§" \
            "3" "PinkÁ≤â" \
            "4" "BlueËìù" \
            "5" "BrownÊ£ï" \
            "6" "DeepPurpleÊ∑±Á¥´" \
            "7" "IndigoÈùõÈùí" \
            "8" "RedÁ∫¢" \
            "9" "TealÊ∞¥È∏≠Áªø" \
            "10" "originÂéüÂßã" \
            "0" "üåö Return to previous menu ËøîÂõû‰∏äÁ∫ßËèúÂçï" \
            3>&1 1>&2 2>&3
    )
    case ${INPUT_METHOD} in
    0 | "") input_method_beautification ;;
    1) install_fcitx5_material_color_theme ;;
    2) delete_fcitx5_material_color_theme ;;
    3)
        PANEL_COLOR_PNG='panel-pink.png'
        HIGH_LIGHT_COLOR_PNG='highlight-pink.png'
        ;;
    4)
        PANEL_COLOR_PNG='panel-blue.png'
        HIGH_LIGHT_COLOR_PNG='highlight-blue.png'
        ;;
    5)
        PANEL_COLOR_PNG='panel-brown.png'
        HIGH_LIGHT_COLOR_PNG='highlight-brown.png'
        ;;
    6)
        PANEL_COLOR_PNG='panel-deepPurple.png'
        HIGH_LIGHT_COLOR_PNG='highlight-deepPurple.png'
        ;;
    7)
        PANEL_COLOR_PNG='panel-indigo.png'
        HIGH_LIGHT_COLOR_PNG='highlight-indigo.png'
        ;;
    8)
        PANEL_COLOR_PNG='panel-red.png'
        HIGH_LIGHT_COLOR_PNG='highlight-red.png'
        ;;
    9)
        PANEL_COLOR_PNG='panel-teal.png'
        HIGH_LIGHT_COLOR_PNG='highlight-teal.png'
        ;;
    10)
        PANEL_COLOR_PNG='panel-origin.png'
        HIGH_LIGHT_COLOR_PNG='highlight-origin.png'
        ;;
    esac
    ###############
    if [ ! -z "${PANEL_COLOR_PNG}" ]; then
        switch__fcitx5_material_color
    fi
    press_enter_to_return
    configure_fcitx5_material_color_theme
}
##############
switch__fcitx5_material_color() {
    if [ ! -e "${MATERIAL_COLOR_FOLDER}" ]; then
        install_fcitx5_material_color_theme
    fi
    cd ${MATERIAL_COLOR_FOLDER}
    if [ "$(command -v catimg)" ]; then
        catimg {PANEL_COLOR_PNG} 2>/dev/null
        catimg ${HIGH_LIGHT_COLOR_PNG} 2>/dev/null
    fi
    ln -sf ${PANEL_COLOR_PNG} panel.png
    ln -sf ${HIGH_LIGHT_COLOR_PNG} highlight.png
    if [ ${HOME} != '/root' ]; then
        echo "Ê≠£Âú®Â∞Üpanel.pngÂíåhighlight.pngÁöÑÊñá‰ª∂ÊùÉÈôê‰øÆÊîπ‰∏∫${CURRENT_USER_NAME}Áî®Êà∑Âíå${CURRENT_USER_GROUP}Áî®Êà∑ÁªÑ"
        chown ${CURRENT_USER_NAME}:${CURRENT_USER_GROUP} panel.png highlight.png
    fi
}
############
delete_fcitx5_material_color_theme() {
    echo "ÊòØÂê¶ÈúÄË¶ÅÂà†Èô§ËØ•‰∏ªÈ¢òÔºü"
    echo "${RED}rm -rv ${MATERIAL_COLOR_FOLDER}${RESET}"
    do_you_want_to_continue
    rm -rv ${MATERIAL_COLOR_FOLDER}
    sed -i 's@^Theme=@#&@' ${FCIITX5_CLASSUI_CONF_FILE}
}
###############
install_fcitx5_material_color_theme() {
    #DEPENDENCY_02='fcitx5-material-color'
    #beta_features_quick_install
    #echo 'ËØ∑ÂâçÂæÄgithubÈòÖËØª‰ΩøÁî®ËØ¥Êòé'
    #echo 'https://github.com/hosxy/Fcitx5-Material-Color'
    if [ ! -e ${MATERIAL_COLOR_FOLDER} ]; then
        mkdir -p ${MATERIAL_COLOR_FOLDER}
        git clone --depth=1 https://github.com/hosxy/Fcitx5-Material-Color.git ${MATERIAL_COLOR_FOLDER}
    else
        cd ${MATERIAL_COLOR_FOLDER}
        git pull
    fi

    mkdir -p ${FCIITX5_CLASSUI_CONF_PATH}
    cd ${FCIITX5_CLASSUI_CONF_PATH}
    if ! grep -q 'Theme=Material-Color-Pink' 'classicui.conf'; then
        write_to_fcitx_classui_conf
    fi

    if [ ${HOME} != '/root' ]; then
        echo "Ê≠£Âú®Â∞Ü${MATERIAL_COLOR_FOLDER}Âíå${FCIITX5_CLASSUI_CONF_PATH}ÁöÑÊñá‰ª∂ÊùÉÈôê‰øÆÊîπ‰∏∫${CURRENT_USER_NAME}Áî®Êà∑Âíå${CURRENT_USER_GROUP}Áî®Êà∑ÁªÑ"
        chown -R ${CURRENT_USER_NAME}:${CURRENT_USER_GROUP} ${MATERIAL_COLOR_FOLDER} ${FCIITX5_CLASSUI_CONF_PATH}
    fi
}
###########
write_to_fcitx_classui_conf() {
    if [ -e classicui.conf ]; then
        sed -i 's@^Vertical Candidate List=@#&@' classicui.conf
        sed -i 's@^PerScreenDPI=@#&@' classicui.conf
        sed -i 's@^Theme=@#&@' classicui.conf
    fi
    cat >>${FCIITX5_CLASSUI_CONF_FILE} <<-'EOF'
		# ÂûÇÁõ¥ÂÄôÈÄâÂàóË°®
		Vertical Candidate List=False

		# ÊåâÂ±èÂπï DPI ‰ΩøÁî®
		PerScreenDPI=True

		# Â≠ó‰Ωì
		#Font="ÊÄùÊ∫êÈªë‰Ωì CN Medium 13"

		# ‰∏ªÈ¢ò
		Theme=Material-Color-Pink
	EOF
}
###########
install_kimpanel() {
    #NON_DEBIAN='true'
    non_debian_function
    DEPENDENCY_02='fcitx5-module-kimpanel'
    beta_features_quick_install
}
#############
install_gnome_shell_extension_kimpanel() {
    DEPENDENCY_02='gnome-shell-extension-kimpanel'
    beta_features_quick_install
}
############
check_fcitx5_dict() {
    if [ ! -d ${FCITX5_DIICT_PATH} ]; then
        mkdir -p ${FCITX5_DIICT_PATH}
    fi
    DICT_FILE="${FCITX5_DIICT_PATH}/${DICT_NAME}"
    DICT_SHARE_FILE=".${FCITX5_DIICT_PATH}/${DICT_NAME}"
    #ÂãøÂøòÁÇπ
    #usr/share/fcitx5/pinyin/dictionaries/
    if [ -e "${DICT_FILE}" ]; then
        echo "Ê£ÄÊµãÂà∞ÊÇ®${RED}Â∑≤Áªè‰∏ãËΩΩËøá${RESET}${DICT_NAME}‰∫Ü"
        echo "ËØ•Êñá‰ª∂‰Ωç‰∫é${BLUE}${FCITX5_DIICT_PATH}${RESET}"
        echo "Â¶ÇÈúÄÂà†Èô§ÔºåËØ∑ÊâãÂä®ÊâßË°å${RED}rm -v ${DICT_FILE}${RESET}"
        ls -lah ${DICT_FILE}
        echo "sha256hash: $(sha256sum ${DICT_FILE})"
        echo "Do you want to ${RED}update it?${RESET}"
        echo "ÊòØÂê¶ÊÉ≥Ë¶ÅÊõ¥Êñ∞ÁâàÊú¨Ôºü"
        do_you_want_to_continue
    fi
}
#############
move_dict_model_01() {
    if [ -e "data.tar.zst" ]; then
        tar --zstd -xvf data.tar.zst &>/dev/null || zstdcat "data.tar.zst" | tar xvf -
    elif [ -e "data.tar.xz" ]; then
        tar -Jxvf data.tar.xz 2>/dev/null
    elif [ -e "data.tar.gz" ]; then
        tar -zxvf data.tar.gz 2>/dev/null
    else
        tar -xvf data.* 2>/dev/null
    fi
    #DICT_SHARE_PATH=fcitx5/pinyin/dictionaries/moegirl.dict
    mv -fv ${DICT_SHARE_FILE} ${FCITX5_DIICT_PATH}
    echo "chmod +r ${DICT_FILE}"
    chmod +r ${DICT_FILE}
    cd ..
    rm -rf /tmp/.${THEME_NAME}
    echo "${BLUE}Êñá‰ª∂${RESET}Â∑≤Áªè‰øùÂ≠òËá≥${DICT_FILE}"
    echo "${BLUE}The file${RESET} have been saved to ${DICT_FILE}"
    ls -lah ${DICT_FILE}
    echo "Â¶ÇÈúÄÂà†Èô§ÔºåËØ∑ÊâãÂä®ÊâßË°årm -v ${DICT_FILE}"
}
###################
download_dict_model_01() {
    GREP_NAME_V='rime'
    THEME_URL='https://mirrors.tuna.tsinghua.edu.cn/archlinuxcn/aarch64/'
    THEME_NAME="${GREP_NAME}"
    FCITX5_DIICT_PATH='/usr/share/fcitx5/pinyin/dictionaries'
    check_fcitx5_dict
    download_arch_community_repo_html
    grep_arch_linux_pkg_03
    move_dict_model_01
}
############
outloudvi_fcitx5_moegirl_dict() {
    DICT_NAME='moegirl.dict'
    GREP_NAME='fcitx5-pinyin-moegirl'
    download_dict_model_01
    echo 'https://github.com/outloudvi/fcitx5-pinyin-moegirl'
}
#################
felixonmars_fcitx5_wiki_dict() {
    DICT_NAME='zhwiki.dict'
    GREP_NAME='fcitx5-pinyin-zhwiki'
    download_dict_model_01
    echo 'https://github.com/felixonmars/fcitx5-pinyin-zhwiki'
}
#################
install_fcitx5() {
    DEPENDENCY_01="fcitx5-chinese-addons fcitx5"
    DEPENDENCY_02=""
    if [ "${LINUX_DISTRO}" = "arch" ]; then
        DEPENDENCY_02='fcitx5-qt fcitx5-gtk kcm-fcitx5'
    elif [ "${LINUX_DISTRO}" = "debian" ]; then
        DEPENDENCY_02='kde-config-fcitx5'
    fi
    configure_system_fcitx5
    beta_features_quick_install
    if [ "${LINUX_DISTRO}" = "debian" ]; then
        if [ ! $(command -v fcitx5-config-qt) ]; then
            DEPENDENCY_01=""
            echo 'Ê£ÄÊµãÂà∞ÊÇ®ÁöÑËΩØ‰ª∂Ê∫ê‰∏≠‰∏çÂåÖÂê´kde-config-fcitx5,ÊÇ®ÂèØ‰ª•Ê∑ªÂä†Á¨¨‰∏âÊñπppaÊ∫êÊù•ÂÆâË£Ö'
            echo "${GREEN}add-apt-repository ppa:hosxy/test${RESET}"
            echo 'Ëã•ppaÊ∫êÊ∑ªÂä†Â§±Ë¥•ÔºåÂàôËØ∑‰ΩøÁî®Êú¨Â∑•ÂÖ∑ÂÜÖÁΩÆÁöÑppaÊ∫êÊ∑ªÂä†Âô®'
            add-apt-repository ppa:hosxy/test
            beta_features_quick_install
        fi
    fi
}
##############
install_fcitx5_rime() {
    DEPENDENCY_01="fcitx5-rime"
    DEPENDENCY_02="fcitx5-pinyin-moegirl-rime"
    if [ "${LINUX_DISTRO}" != "arch" ]; then
        echo 'Êà™Ëá≥20200723ÔºåÊú¨ÂäüËÉΩÊöÇÂè™ÈÄÇÈÖçArchÁ≥ªÂèëË°åÁâà'
    fi
    configure_system_fcitx5
    beta_features_quick_install
}
#################
install_pinyin_input_method() {
    RETURN_TO_WHERE='install_pinyin_input_method'
    
    DEPENDENCY_01="fcitx"
    if [ "${LINUX_DISTRO}" = "arch" ]; then
        DEPENDENCY_01='fcitx-im fcitx-configtool'
        #kcm-fcitx
    elif [ "${LINUX_DISTRO}" = "debian" ]; then
        DEPENDENCY_01='fcitx fcitx-tools fcitx-config-gtk'
        #kde-config-fcitx
    fi
    INPUT_METHOD=$(
        whiptail --title "ËæìÂÖ•Ê≥ï" --menu "ÊÇ®ÊÉ≥Ë¶ÅÂÆâË£ÖÂì™‰∏™ËæìÂÖ•Ê≥ïÂë¢Ôºü\nWhich input method do you want to install?" 17 55 8 \
            "1" "üçÅ fcitx-FAQ:Â∏∏ËßÅÈóÆÈ¢ò‰∏éÁñëÈöæËØäÊñ≠" \
            "2" "üçÄ fcitx5(ËΩØ‰ª∂‰∏éËØçÂ∫ì)" \
            "3" "googleË∞∑Ê≠åÊãºÈü≥(ÂºïÊìéforkËá™AndroidÁâà)" \
            "4" "sogou(ÊêúÁãóÊãºÈü≥)" \
            "5" "iflyime(ËÆØÈ£ûËØ≠Èü≥+ÊãºÈü≥+‰∫îÁ¨î)" \
            "6" "rime‰∏≠Â∑ûÈüª(ÊìäÈüø‰∏≠Êñá‰πãÈüª)" \
            "7" "baidu(ÁôæÂ∫¶ËæìÂÖ•Ê≥ï)" \
            "8" "libpinyin(Êèê‰æõÊô∫ËÉΩÊï¥Âè•ËæìÂÖ•ÁÆóÊ≥ïÊ†∏ÂøÉ)" \
            "9" "sunpinyin(Âü∫‰∫éÁªüËÆ°Â≠¶ËØ≠Ë®ÄÊ®°Âûã)" \
            "10" "fcitx-‰∫ëÊãºÈü≥Ê®°Âùó" \
            "11" "onboard(Â±èÂπïËôöÊãüÈîÆÁõò)" \
            "12" "uim(Universal Input Method)" \
            "0" "üåö Return to previous menu ËøîÂõû‰∏äÁ∫ßËèúÂçï" \
            3>&1 1>&2 2>&3
    )
    case ${INPUT_METHOD} in
    0 | "") beta_features ;;
    1) tmoe_fcitx_faq ;;
    2) tmoe_fcitx5_menu ;;
    3) install_google_pinyin ;;
    4) install_sogou_pinyin ;;
    5) install_iflyime_pinyin ;;
    6) install_rime_pinyin ;;
    7) install_baidu_pinyin ;;
    8) install_lib_pinyin ;;
    9) install_sun_pinyin ;;
    10) install_fcitx_module_cloud_pinyin ;;
    11) install_onboard ;;
    12) install_uim_pinyin ;;
    esac
    ###############
    configure_arch_fcitx
    press_enter_to_return
    install_pinyin_input_method
}
########################
install_onboard() {
    DEPENDENCY_01=''
    DEPENDENCY_02='onboard'
    beta_features_quick_install
}
##################
tmoe_fcitx_faq() {
    
    DEPENDENCY_01=''
    RETURN_TO_WHERE='tmoe_fcitx_faq'
    TMOE_APP=$(whiptail --title "Fcitx FAQ" --menu \
        "‰Ω†ÊÉ≥Ë¶ÅÂØπËøô‰∏™Â∞èÂèØÁà±ÂÅö‰ªÄ‰πà?" 0 50 5 \
        "1" "fcitx-diagnose:ËØäÊñ≠" \
        "2" "KDE-fcitx4-Ê®°Âùó" \
        "3" "remove ibusÁßªÈô§ibus(Èò≤Ê≠¢ÂÜ≤Á™Å)" \
        "4" "im-config:ÈÖçÁΩÆfcitx4ËæìÂÖ•Ê≥ï" \
        "5" "edit .xprofile(ËøõÂÖ•Ê°åÈù¢ÂêéËá™Âä®ÊâßË°åÁöÑÈÖçÁΩÆ)" \
        "6" "edit .pam_environment(Áî®Êà∑ÁéØÂ¢ÉÂèòÈáèÈÖçÁΩÆÊñá‰ª∂)" \
        "7" "edit /etc/environment(Á≥ªÁªüÁéØÂ¢ÉÂèòÈáèÈÖçÁΩÆÊñá‰ª∂)" \
        "0" "üåö Return to previous menu ËøîÂõû‰∏äÁ∫ßËèúÂçï" \
        3>&1 1>&2 2>&3)
    ##########################
    case "${TMOE_APP}" in
    0 | "") install_pinyin_input_method ;;
    1)
        echo 'Ëã•ÊÇ®Êó†Ê≥ï‰ΩøÁî®fcitx,ÂàôËØ∑Ê†πÊçÆ‰ª•‰∏ãËØäÊñ≠‰ø°ÊÅØËá™Ë°åËß£ÂÜ≥'
        fcitx-diagnose
        ;;
    2) kde_config_module_for_fcitx ;;
    3) remove_ibus_im ;;
    4) input_method_config ;;
    5)
        FCITX_ENV_FILE="${HOME}/.xprofile"
        edit_fcitx_env_file
        ;;
    6)
        FCITX_ENV_FILE="${HOME}/.pam_environment"
        edit_fcitx_env_file
        ;;
    7)
        FCITX_ENV_FILE="/etc/environment"
        edit_fcitx_env_file
        ;;
    esac
    ##########################
    press_enter_to_return
    tmoe_fcitx_faq
}
#################
edit_fcitx_env_file() {
    if [ $(command -v editor) ]; then
        editor ${FCITX_ENV_FILE}
    else
        nano ${FCITX_ENV_FILE}
    fi
    chown ${CURRENT_USER_NAME}:${CURRENT_USER_GROUP} ${FCITX_ENV_FILE}
}
###########
remove_ibus_im() {
    ${TMOE_REMOVAL_COMMAND} ibus
    if [ "${LINUX_DISTRO}" = "debian" ]; then
        apt autoremove
    fi
}
##########
input_method_config() {
    cd ${HOME}
    if grep '^fcitx5' .xprofile; then
        sed -i 's@^fcitx5@#&@' .xprofile
        sed -i '1a\fcitx || fcitx5' .xprofile
    fi
    if ! grep '^fcitx' .xprofile; then
        sed -i '1a\fcitx || fcitx5' .xprofile
    fi
    #NON_DEBIAN='true'
    non_debian_function
    if [ ! $(command -v im-config) ]; then
        DEPENDENCY_01=''
        DEPENDENCY_02='im-config'
        beta_features_quick_install
    fi
    #Ê£ÄÊµã‰∏§Ê¨°
    if [ ! $(command -v im-config) ]; then
        echo 'SorryÔºåÊú¨ÂäüËÉΩÂè™ÊîØÊåÅdebÁ≥ªÂèëË°åÁâà'
    fi
    im-config
    chmod 755 -R .config/fcitx .xprofile
    if [ ${HOME} != '/root' ]; then
        echo "Ê≠£Âú®Â∞Ü${HOME}/.config/fcitxÂíå${HOME}/.xprofileÁöÑÊñá‰ª∂ÊùÉÈôê‰øÆÊîπ‰∏∫${CURRENT_USER_NAME}Áî®Êà∑Âíå${CURRENT_USER_GROUP}Áî®Êà∑ÁªÑ"
        chown -R ${CURRENT_USER_NAME}:${CURRENT_USER_GROUP} .config/fcitx .xprofile
    fi
    fcitx &>/dev/null || fcitx5 &>/dev/null
    echo "ËØ∑ÊâãÂä®‰øÆÊîπÈîÆÁõòÂ∏ÉÂ±ÄÔºåÂπ∂ÊâìÂºÄfcitx-configtool"
}
####################
install_uim_pinyin() {
    DEPENDENCY_01='uim uim-mozc'
    DEPENDENCY_02='uim-pinyin'
    beta_features_quick_install
}
###########
install_fcitx_module_cloud_pinyin() {
    DEPENDENCY_01=''
    if [ "${LINUX_DISTRO}" = "debian" ]; then
        DEPENDENCY_02='fcitx-module-cloudpinyin'
    else
        DEPENDENCY_02='fcitx-cloudpinyin'
    fi
    beta_features_quick_install
}
######################
install_rime_pinyin() {
    DEPENDENCY_02='fcitx-rime'
    beta_features_quick_install
}
#############
install_lib_pinyin() {
    DEPENDENCY_02='fcitx-libpinyin'
    beta_features_quick_install
}
######################
install_sun_pinyin() {
    DEPENDENCY_02='fcitx-sunpinyin'
    beta_features_quick_install
}
###########
install_google_pinyin() {
    DEPENDENCY_02='fcitx-googlepinyin'
    beta_features_quick_install
}
###########
install_debian_baidu_pinyin() {
    DEPENDENCY_02="fcitx-baidupinyin"
    if [ ! $(command -v unzip) ]; then
        ${TMOE_INSTALLATON_COMMAND} unzip
    fi
    ###################
    if [ "${ARCH_TYPE}" = "amd64" ]; then
        mkdir /tmp/.BAIDU_IME
        cd /tmp/.BAIDU_IME
        THE_Latest_Link='https://imeres.baidu.com/imeres/ime-res/guanwang/img/Ubuntu_Deepin-fcitx-baidupinyin-64.zip'
        echo ${THE_Latest_Link}
        aria2c --allow-overwrite=true -s 5 -x 5 -k 1M -o 'fcitx-baidupinyin.zip' "${THE_Latest_Link}"
        unzip 'fcitx-baidupinyin.zip'
        DEB_FILE_NAME="$(ls -l ./*deb | grep ^- | head -n 1 | awk -F ' ' '$0=$NF')"
        apt install ${DEB_FILE_NAME}
    else
        echo "Êû∂ÊûÑ‰∏çÊîØÊåÅÔºåË∑≥ËøáÂÆâË£ÖÁôæÂ∫¶ËæìÂÖ•Ê≥ï„ÄÇ"
        arch_does_not_support
    fi
    apt show ./fcitx-baidupinyin.deb
    apt install -y ./fcitx-baidupinyin.deb
    echo "Ëã•ÂÆâË£ÖÂ§±Ë¥•ÔºåÂàôËØ∑ÂâçÂæÄÂÆòÁΩëÊâãÂä®‰∏ãËΩΩÂÆâË£Ö„ÄÇ"
    echo 'url: https://srf.baidu.com/site/guanwang_linux/index.html'
    cd /tmp
    rm -rfv /tmp/.BAIDU_IME
    beta_features_install_completed
}
########
install_pkg_warning() {
    echo "Ê£ÄÊµãÂà∞${YELLOW}ÊÇ®Â∑≤ÂÆâË£Ö${RESET} ${GREEN} ${DEPENDENCY_02} ${RESET}"
    echo "Â¶ÇÈúÄ${RED}Âç∏ËΩΩ${RESET}ÔºåËØ∑ÊâãÂä®Ëæì${BLUE} ${TMOE_REMOVAL_COMMAND} ${DEPENDENCY_02} ${RESET}"
    press_enter_to_reinstall_yes_or_no
}
#############
install_baidu_pinyin() {
    DEPENDENCY_02="fcitx-baidupinyin"
    if [ -e "/opt/apps/com.baidu.fcitx-baidupinyin/" ]; then
        install_pkg_warning
    fi

    if [ "${LINUX_DISTRO}" = "arch" ]; then
        DEPENDENCY_02="fcitx-baidupinyin"
        beta_features_quick_install
    elif [ "${LINUX_DISTRO}" = "debian" ]; then
        install_debian_baidu_pinyin
    else
        non_debian_function
    fi
}
##########
#Â∑≤Â∫üÂºÉÔºÅ
sougou_pinyin_amd64() {
    if [ "${ARCH_TYPE}" = "amd64" ] || [ "${ARCH_TYPE}" = "i386" ]; then
        LatestSogouPinyinLink=$(curl -L 'https://pinyin.sogou.com/linux' | grep ${ARCH_TYPE} | grep 'deb' | head -n 1 | cut -d '=' -f 3 | cut -d '?' -f 1 | cut -d '"' -f 2)
        echo ${LatestSogouPinyinLink}
        aria2c --allow-overwrite=true -s 5 -x 5 -k 1M -o 'sogou_pinyin.deb' "${LatestSogouPinyinLink}"
    else
        echo "Êû∂ÊûÑ‰∏çÊîØÊåÅÔºåË∑≥ËøáÂÆâË£ÖÊêúÁãóËæìÂÖ•Ê≥ï„ÄÇ"
        arch_does_not_support
    fi
}
###################
install_debian_sogou_pinyin() {
    #DEPENDENCY_02="sogouimebs"
    DEPENDENCY_02='sogoupinyin'
    ###################
    if [ -e "/usr/share/fcitx-sogoupinyin" ] || [ -e "/usr/share/sogouimebs/" ]; then
        install_pkg_warning
    fi
    case "${ARCH_TYPE}" in
    amd64 | i386)
        echo "Êú¨ËÑöÊú¨Êèê‰æõÁöÑÊòØÊêúÁãóÂÆòÁΩëÁöÑÁâàÊú¨"
        echo "Debian sid„ÄÅKali rollingÂíåubuntu 20.04Á≠âÈ´òÁâàÊú¨ÂèØËÉΩÊó†Ê≥ïÊ≠£Â∏∏ËøêË°å,ÊÇ®ÂèØ‰ª•ÂâçÂæÄ‰ºòÈ∫íÈ∫üËΩØ‰ª∂‰ªìÂ∫ìÊâãÂä®‰∏ãËΩΩÂÆâË£Ö„ÄÇ"
        echo 'http://archive.ubuntukylin.com/ukui/pool/main/s/sogouimebs/'
        do_you_want_to_continue
        LATEST_DEB_URL=$(curl -L 'https://pinyin.sogou.com/linux/' | grep ${ARCH_TYPE} | grep deb | awk '{print $3}' | cut -d '"' -f 2)
        LATEST_DEB_VERSION="sogouimebs_${ARCH_TYPE}.deb"
        install_deb_file_common_model_02
        ;;
    arm64) echo "ËØ∑ÊâãÂä®ÂâçÂæÄ‰ºòÈ∫íÈ∫üËΩØ‰ª∂‰ªìÂ∫ìÊâãÂä®‰∏ãËΩΩÂÆâË£Öarm64Áâàsogouimebs" ;;
    esac
    echo "Ëã•ÂÆâË£ÖÂ§±Ë¥•ÔºåÂàôËØ∑ÂâçÂæÄÂÆòÁΩëÊâãÂä®‰∏ãËΩΩÂÆâË£Ö„ÄÇ"
    echo "url: ${YELLOW}https://pinyin.sogou.com/linux/${RESET}"
    beta_features_install_completed
}
########
install_sogou_pinyin() {
    if [ "${LINUX_DISTRO}" = "arch" ]; then
        DEPENDENCY_02="fcitx-sogouimebs"
        beta_features_quick_install
    elif [ "${LINUX_DISTRO}" = "debian" ]; then
        install_debian_sogou_pinyin
    else
        non_debian_function
    fi
}
############
fcitx5_config_file() {
    if [ ! -e "${FCITX5_FILE}" ]; then
        echo '' >>${FCITX5_FILE}
    fi
    if ! grep -q '^export GTK_IM_MODULE=fcitx5' ${FCITX5_FILE}; then
        sed -i 's/^export INPUT_METHOD.*/#&/' ${FCITX5_FILE}
        sed -i 's/^export GTK_IM_MODULE.*/#&/' ${FCITX5_FILE}
        sed -i 's/^export QT_IM_MODULE=.*/#&/' ${FCITX5_FILE}
        sed -i 's/^export XMODIFIERS=.*/#&/' ${FCITX5_FILE}
        cat >>${FCITX5_FILE} <<-'EOF'
			export INPUT_METHOD=fcitx5
			export GTK_IM_MODULE=fcitx5
			export QT_IM_MODULE=fcitx5
			export XMODIFIERS="@im=fcitx5"
		EOF
    fi
}
############
fix_fcitx5_permissions() {
    if [ ${HOME} != '/root' ]; then
        echo "Ê≠£Âú®Â∞Ü${FCITX5_FILE}ÁöÑÊñá‰ª∂ÊùÉÈôê‰øÆÊîπ‰∏∫${CURRENT_USER_NAME}Áî®Êà∑Âíå${CURRENT_USER_GROUP}Áî®Êà∑ÁªÑ"
        chown -R ${CURRENT_USER_NAME}:${CURRENT_USER_GROUP} ${FCITX5_FILE}
    fi
}
############
configure_system_fcitx5() {
    FCITX5_FILE="${HOME}/.xprofile"
    cd ${HOME}
    fcitx5_config_file
    if ! grep -q '^fcitx5' .xprofile; then
        sed -i 's@^fcitx@#&@g' .xprofile
        sed -i '1a\fcitx5 || fcitx' .xprofile
    fi
    fix_fcitx5_permissions
    FCITX5_FILE='/etc/environment'
    fcitx5_config_file
    FCITX5_FILE="${HOME}/.pam_environment"
    fcitx5_config_file
    fix_fcitx5_permissions
}
##############
configure_arch_fcitx() {
    if [ ! -e "${HOME}/.xprofile" ]; then
        echo '' >${HOME}/.xprofile
    fi
    if grep -q '^export GTK_IM_MODULE=fcitx5' ${HOME}/.xprofile; then
        sed -i 's/^export GTK_IM_MODULE.*/#&/' ${HOME}/.xprofile ${HOME}/.pam_environment
        sed -i 's/^export QT_IM_MODULE=.*/#&/' ${HOME}/.xprofile ${HOME}/.pam_environment
        sed -i 's/^export XMODIFIERS=.*/#&/' ${HOME}/.xprofile ${HOME}/.pam_environment
    fi

    if ! grep -q '^export GTK_IM_MODULE=fcitx' ${HOME}/.xprofile; then
        sed -i 's/^export GTK_IM_MODULE.*/#&/' ${HOME}/.xprofile
        sed -i 's/^export QT_IM_MODULE=.*/#&/' ${HOME}/.xprofile
        sed -i 's/^export XMODIFIERS=.*/#&/' ${HOME}/.xprofile
        cat >>${HOME}/.xprofile <<-'EOF'
			export GTK_IM_MODULE=fcitx
			export QT_IM_MODULE=fcitx
			export XMODIFIERS="@im=fcitx"
		EOF
        #sort -u ${HOME}/.xprofile -o ${HOME}/.xprofile
    fi
    if ! grep -q '^export GTK_IM_MODULE=fcitx' /etc/environment; then
        sed -i 's/^export INPUT_METHOD.*/#&/' /etc/environment
        sed -i 's/^export GTK_IM_MODULE.*/#&/' /etc/environment
        sed -i 's/^export QT_IM_MODULE=.*/#&/' /etc/environment
        sed -i 's/^export XMODIFIERS=.*/#&/' /etc/environment
        cat >>/etc/environment <<-'EOF'
			export INPUT_METHOD=fcitx
			export GTK_IM_MODULE=fcitx
			export QT_IM_MODULE=fcitx
			export XMODIFIERS="@im=fcitx"
		EOF
        #sort -u /etc/environment -o /etc/environment
    fi
}
##############
install_debian_iflyime_pinyin() {
    DEPENDENCY_02="iflyime"
    beta_features_quick_install
    case "${ARCH_TYPE}" in
    amd64)
        REPO_URL='https://mirrors.tuna.tsinghua.edu.cn/deepin/pool/non-free/i/iflyime/'
        GREP_NAME="${ARCH_TYPE}"
        grep_deb_comman_model_01
        ;;
    *)
        echo "ËØ∑Âú®Êõ¥Êç¢x64Êû∂ÊûÑÁöÑËÆæÂ§áÂêéÔºåÂÜçÊù•Â∞ùËØï"
        arch_does_not_support
        ;;
    esac
}
#############
install_iflyime_pinyin() {
    if [ "${LINUX_DISTRO}" = "arch" ]; then
        DEPENDENCY_02="iflyime"
        beta_features_quick_install
    elif [ "${LINUX_DISTRO}" = "debian" ]; then
        install_debian_iflyime_pinyin
    else
        non_debian_function
    fi
}
################
####################
install_pinyin_input_method
